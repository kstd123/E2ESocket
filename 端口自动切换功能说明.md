# 端口自动切换功能说明

## 🎉 功能简介

现在，E2E WebSocket 服务器支持**智能端口管理**！当配置的端口被占用时，服务器会自动查找并使用下一个可用端口，无需手动修改配置。

## ✨ 功能特点

### 1. 自动检测

启动时自动检测配置的端口是否可用：

```bash
$ npm start

正在检查端口可用性...
✓ 端口检查完成
```

### 2. 智能切换

如果端口被占用，自动使用备用端口：

```bash
$ npm start

正在检查端口可用性...
⚠️  WebSocket 端口 8080 被占用，使用备用端口 8081
⚠️  HTTP API 端口 3000 被占用，使用备用端口 3001

✓ WebSocket Server: ws://localhost:8081
✓ HTTP API Server: http://localhost:3001
```

### 3. 友好提示

清晰的控制台输出，让你知道服务器实际使用的端口。

### 4. 灵活配置

多种方式配置端口：

```bash
# 方式 1: 自动切换（推荐）
npm start

# 方式 2: 环境变量
WS_PORT=9090 API_PORT=4000 npm start

# 方式 3: 修改配置文件
# 编辑 config/config.js
```

## 🚀 使用方法

### 基础使用

直接启动服务器，一切都是自动的：

```bash
npm start
```

服务器会：
1. 检查配置的端口（默认 8080 和 3000）
2. 如果可用，使用配置的端口
3. 如果被占用，自动使用下一个可用端口
4. 显示实际使用的端口地址

### 指定端口

如果你想使用特定端口：

```bash
# Unix/Linux/macOS
WS_PORT=9090 API_PORT=4000 npm start

# Windows CMD
set WS_PORT=9090 && set API_PORT=4000 && npm start

# Windows PowerShell
$env:WS_PORT=9090; $env:API_PORT=4000; npm start
```

### 永久修改

编辑 `config/config.js`：

```javascript
export const config = {
  wsPort: parseInt(process.env.WS_PORT) || 9090,  // 改为你想要的端口
  apiPort: parseInt(process.env.API_PORT) || 4000,
  // ...
};
```

## 🔧 工作原理

### 端口查找算法

1. **首选端口**：尝试使用配置的端口
2. **依次检查**：如果被占用，检查 port+1, port+2, ...
3. **查找范围**：默认检查 100 个端口
4. **返回结果**：返回第一个可用的端口

### 代码实现

核心功能在 `src/utils/port-finder.js`：

```javascript
// 检测端口是否可用
isPortAvailable(port) → Promise<boolean>

// 查找可用端口
findAvailablePort(startPort, maxAttempts) → Promise<number>

// 获取多个可用端口
getAvailablePorts(preferredPorts, count) → Promise<number[]>
```

服务器启动流程（`server.js`）：

```javascript
// 1. 检查端口
const preferredPorts = [config.wsPort, config.apiPort];
const availablePorts = await getAvailablePorts(preferredPorts, 2);

// 2. 获取实际使用的端口
const wsPort = availablePorts[0];
const apiPort = availablePorts[1];

// 3. 显示变更信息
if (wsPort !== config.wsPort) {
  console.log(`⚠️  WebSocket 端口 ${config.wsPort} 被占用，使用备用端口 ${wsPort}`);
}

// 4. 启动服务器
await wsServer.start(wsPort);
await apiServer.listen(apiPort);
```

## 📊 测试

### 测试端口切换功能

运行专用测试脚本：

```bash
npm run test:port
```

测试内容：
1. ✓ 检查默认端口状态
2. ✓ 测试端口查找功能
3. ✓ 模拟端口被占用场景
4. ✓ 查找备用端口
5. ✓ 清理测试资源

### 手动测试

**测试 1: 正常启动**

```bash
# 终端 1
npm start
# 应该使用默认端口 8080 和 3000
```

**测试 2: 端口冲突**

```bash
# 终端 1
npm start

# 终端 2（开启新终端）
npm start
# 应该自动使用 8081 和 3001
```

**测试 3: 指定端口**

```bash
# 使用自定义端口
WS_PORT=9090 API_PORT=4000 npm start
# 应该使用 9090 和 4000
```

## 🎯 使用场景

### 场景 1: 开发环境

多个开发者或多个项目实例同时运行：

```bash
# 项目 A
cd /path/to/projectA
npm start  # 使用 8080, 3000

# 项目 B
cd /path/to/projectB
npm start  # 自动使用 8081, 3001
```

### 场景 2: 测试环境

运行多个测试实例：

```bash
# 主服务器
npm start

# 测试实例 1
WS_PORT=8082 API_PORT=3002 npm start

# 测试实例 2
WS_PORT=8083 API_PORT=3003 npm start
```

### 场景 3: CI/CD

在 CI/CD 环境中，端口可能不可预测：

```yaml
# .github/workflows/test.yml
- name: Start Server
  run: npm start  # 自动找到可用端口
```

## 🔍 故障排查

### 问题 1: 所有端口都被占用

**错误信息**:
```
无法找到可用端口，已尝试 8080 到 8179
```

**解决方案**:
- 检查是否有大量进程占用端口
- 增加查找范围（修改 `port-finder.js` 中的 `maxAttempts`）
- 手动指定更高的起始端口

### 问题 2: 权限不足

**错误信息**:
```
Error: listen EACCES: permission denied 0.0.0.0:80
```

**解决方案**:
- 使用非特权端口（>1024）
- 使用 sudo（不推荐）
- 使用反向代理

### 问题 3: 端口仍然报错

**检查步骤**:

1. 确认没有其他实例在运行
```bash
ps aux | grep node
pm2 list
```

2. 检查端口占用
```bash
# macOS/Linux
lsof -i :8080
netstat -vanp tcp | grep 8080

# Windows
netstat -ano | findstr :8080
```

3. 终止占用进程
```bash
# macOS/Linux
kill -9 <PID>

# Windows
taskkill /PID <PID> /F
```

## 📚 相关文档

- **[docs/PORT_MANAGEMENT.md](docs/PORT_MANAGEMENT.md)** - 完整的端口管理指南
- **[QUICKSTART.md](QUICKSTART.md)** - 快速开始和常见问题
- **[README.md](README.md)** - 项目完整文档
- **[CHANGELOG.md](CHANGELOG.md)** - 更新日志

## 💡 最佳实践

### 1. 开发环境

使用默认端口 + 自动切换：

```bash
npm run dev
```

### 2. 生产环境

使用环境变量明确指定端口：

```bash
WS_PORT=8080 API_PORT=3000 npm start
```

### 3. Docker 环境

在 docker-compose.yml 中映射端口：

```yaml
services:
  app:
    ports:
      - "8080:8080"
      - "3000:3000"
    environment:
      - WS_PORT=8080
      - API_PORT=3000
```

### 4. PM2 环境

在 ecosystem.config.js 中配置：

```javascript
module.exports = {
  apps: [{
    name: 'e2e-socket',
    script: './server.js',
    env_production: {
      WS_PORT: 8080,
      API_PORT: 3000
    }
  }]
};
```

## 🎓 技术细节

### 实现文件

- **`src/utils/port-finder.js`** - 端口查找核心逻辑
- **`server.js`** - 服务器启动和端口管理
- **`src/websocket/WebSocketServer.js`** - WebSocket 服务器
- **`config/config.js`** - 配置文件

### 依赖

使用 Node.js 内置模块：
- `net` - 网络操作
- `process` - 环境变量

无需额外安装依赖包！

## 🔄 版本历史

- **v1.1.0** (2025-11-17) - 新增端口自动切换功能
- **v1.0.0** (2025-11-17) - 首次发布

## 🤝 反馈

如有问题或建议，请：

1. 查看文档
2. 运行测试：`npm run test:port`
3. 提交 Issue
4. 发送 Pull Request

---

**享受无忧的端口管理体验！** 🎉


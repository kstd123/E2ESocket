<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E2E WebSocket Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        /* ä¸»å®¹å™¨ - å¾®ä¿¡é£æ ¼å¸ƒå±€ */
        .wechat-container {
            display: flex;
            height: 100vh;
            background: white;
        }

        /* å·¦ä¾§è¾¹æ  */
        .sidebar {
            width: 260px;
            background: #2e2e2e;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e0e0e0;
        }

        .sidebar-header {
            padding: 20px;
            background: #2e2e2e;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #3e3e3e;
        }

        .sidebar-header h1 {
            font-size: 16px;
            font-weight: normal;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff4444;
            display: inline-block;
            margin-right: 8px;
        }

        .status-dot.connected {
            background: #07C160;
        }

        /* è¿æ¥è®¾ç½® */
        .connection-panel {
            padding: 15px;
            background: #3e3e3e;
            border-bottom: 1px solid #4e4e4e;
        }

        .connection-panel input {
            width: 100%;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background: #2e2e2e;
            color: white;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .connection-panel input::placeholder {
            color: #888;
        }

        .connection-panel button {
            width: 48%;
            padding: 8px;
            border: none;
            border-radius: 4px;
            background: #07C160;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .connection-panel button:hover {
            opacity: 0.8;
        }

        .connection-panel button:last-child {
            background: #555;
            margin-left: 4%;
        }

        /* æˆ¿é—´åˆ—è¡¨ */
        .room-list {
            flex: 1;
            overflow-y: auto;
            background: #2e2e2e;
        }

        .room-item {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid #3e3e3e;
            transition: background 0.2s;
            color: white;
        }

        .room-item:hover {
            background: #3e3e3e;
        }

        .room-item.active {
            background: #3e3e3e;
        }

        .room-item-title {
            font-size: 14px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .room-item-info {
            font-size: 12px;
            color: #888;
        }

        .room-badge {
            background: #07C160;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
        }

        /* ä¸»èŠå¤©åŒºåŸŸ */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
        }

        /* èŠå¤©å¤´éƒ¨ */
        .chat-header {
            height: 60px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .chat-title {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }

        .chat-info {
            font-size: 12px;
            color: #999;
        }

        .chat-actions button {
            padding: 6px 15px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 4px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .chat-actions button:hover {
            background: #f5f5f5;
        }

        /* æ¶ˆæ¯åŒºåŸŸ */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f5f5f5;
        }

        /* æ¶ˆæ¯æ°”æ³¡ */
        .message-wrapper {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
        }

        .message-wrapper.mine {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            background: #07C160;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            flex-shrink: 0;
        }

        .message-wrapper.mine .message-avatar {
            background: #95EC69;
        }

        .message-content-wrapper {
            max-width: 60%;
            margin: 0 10px;
        }

        .message-info {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .message-wrapper.mine .message-info {
            text-align: right;
        }

        .message-bubble {
            padding: 10px 15px;
            border-radius: 4px;
            word-wrap: break-word;
            position: relative;
            display: inline-block;
            max-width: 100%;
        }

        /* åˆ«äººçš„æ¶ˆæ¯ - ç™½è‰²æ°”æ³¡ */
        .message-bubble.other {
            background: white;
            color: #333;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .message-bubble.other::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 12px;
            width: 0;
            height: 0;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-right: 8px solid white;
        }

        /* è‡ªå·±çš„æ¶ˆæ¯ - ç»¿è‰²æ°”æ³¡ */
        .message-bubble.mine {
            background: #95EC69;
            color: #333;
        }

        .message-wrapper.mine .message-bubble {
            text-align: left;
        }

        .message-bubble.mine::after {
            content: '';
            position: absolute;
            right: -8px;
            top: 12px;
            width: 0;
            height: 0;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-left: 8px solid #95EC69;
        }

        /* ç³»ç»Ÿæ¶ˆæ¯ */
        .system-message {
            text-align: center;
            margin: 15px 0;
            font-size: 12px;
            color: #999;
        }

        .system-message span {
            background: rgba(0, 0, 0, 0.05);
            padding: 4px 12px;
            border-radius: 4px;
            display: inline-block;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 15px 20px;
        }

        .input-toolbar {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 20px;
            color: #666;
        }

        .input-toolbar span {
            cursor: pointer;
            transition: color 0.2s;
        }

        .input-toolbar span:hover {
            color: #07C160;
        }

        .input-box {
            display: flex;
            gap: 10px;
        }

        .input-box input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
        }

        .input-box input:focus {
            border-color: #07C160;
        }

        .send-button {
            padding: 10px 30px;
            background: #07C160;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: opacity 0.2s;
        }

        .send-button:hover {
            opacity: 0.8;
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* æˆ¿é—´åŠ å…¥é¢æ¿ */
        .join-room-panel {
            padding: 15px;
            background: #3e3e3e;
            border-bottom: 1px solid #4e4e4e;
        }

        .join-room-panel input,
        .join-room-panel select {
            width: 100%;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background: #2e2e2e;
            color: white;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .join-room-panel button {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 4px;
            background: #07C160;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .join-room-panel button:hover {
            opacity: 0.8;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        /* é…ç½®ç¼–è¾‘å™¨ */
        .config-editor {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .config-editor.show {
            display: flex;
        }

        .config-editor-content {
            background: white;
            border-radius: 8px;
            width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .config-editor-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .config-editor-header h2 {
            font-size: 18px;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .close-btn:hover {
            color: #333;
        }

        .config-editor-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .config-editor-body textarea {
            width: 100%;
            height: 300px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
        }

        .config-editor-footer {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .config-version {
            font-size: 12px;
            color: #999;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        /* äºŒç»´ç æ˜¾ç¤º */
        .qrcode-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .qrcode-modal.show {
            display: flex;
        }

        .qrcode-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
        }

        .qrcode-content h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .qrcode-content img {
            max-width: 300px;
            margin: 20px 0;
        }

        .qrcode-content .room-info {
            font-size: 14px;
            color: #666;
            margin: 10px 0;
        }

        .admin-badge {
            background: #ff9800;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
        }
    </style>
</head>

<body>
    <!-- å¾®ä¿¡é£æ ¼ä¸»å®¹å™¨ -->
    <div class="wechat-container">
        <!-- å·¦ä¾§è¾¹æ  -->
        <div class="sidebar">
            <!-- ä¾§è¾¹æ å¤´éƒ¨ -->
            <div class="sidebar-header">
                <h1>
                    <span class="status-dot" id="statusDot"></span>
                    E2E Chat
                </h1>
            </div>

            <!-- è¿æ¥è®¾ç½® -->
            <div class="connection-panel">
                <input type="text" id="serverUrl" placeholder="æœåŠ¡å™¨åœ°å€">
                <div style="display: flex; gap: 10px;">
                    <button onclick="connect()">è¿æ¥</button>
                    <button onclick="disconnect()">æ–­å¼€</button>
                </div>
            </div>

            <!-- åŠ å…¥æˆ¿é—´ -->
            <div class="join-room-panel">
                <input type="text" id="roomIdInput" placeholder="æˆ¿é—´å·ï¼ˆç•™ç©ºè‡ªåŠ¨ç”Ÿæˆï¼‰">
                <select id="permissionSelect">
                    <option value="read_write">å¯è¯»å¯å†™</option>
                    <option value="read_only">åªè¯»</option>
                </select>
                <button onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
            </div>

            <!-- æˆ¿é—´åˆ—è¡¨ -->
            <div class="room-list" id="roomList">
                <div class="room-item active" id="currentRoomItem" style="display: none;">
                    <div class="room-item-title">
                        <span id="roomName">å½“å‰æˆ¿é—´</span>
                        <span class="room-badge" id="memberCountBadge">0äºº</span>
                    </div>
                    <div class="room-item-info" id="roomPermission">æƒé™: -</div>
                </div>
            </div>
        </div>

        <!-- ä¸»èŠå¤©åŒºåŸŸ -->
        <div class="chat-main">
            <!-- èŠå¤©å¤´éƒ¨ -->
            <div class="chat-header">
                <div>
                    <div class="chat-title" id="chatTitle">E2E WebSocket Chat</div>
                    <div class="chat-info" id="chatInfo">è¯·è¿æ¥æœåŠ¡å™¨å¹¶åŠ å…¥æˆ¿é—´å¼€å§‹èŠå¤©</div>
                </div>
                <div class="chat-actions">
                    <button onclick="showQRCode()" id="qrcodeBtn" style="display:none;">ğŸ“± äºŒç»´ç </button>
                    <button onclick="openConfigEditor()" id="configBtn" style="display:none;">âš™ï¸ é…ç½®</button>
                    <button onclick="getRoomInfo()">æˆ¿é—´ä¿¡æ¯</button>
                    <button onclick="leaveRoom()">ç¦»å¼€æˆ¿é—´</button>
                </div>
            </div>

            <!-- æ¶ˆæ¯åŒºåŸŸ -->
            <div class="messages-container" id="messagesContainer">
                <div class="system-message">
                    <span>æ¬¢è¿ä½¿ç”¨ E2E WebSocket Chat</span>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="input-area">
                <div class="input-toolbar">
                    <span title="è¡¨æƒ…">ğŸ˜€</span>
                    <span title="æ–‡ä»¶">ğŸ“</span>
                    <span title="å›¾ç‰‡">ğŸ–¼ï¸</span>
                </div>
                <div class="input-box">
                    <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="handleKeyPress(event)">
                    <button class="send-button" onclick="sendMessage()" id="sendButton" disabled>å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <!-- é…ç½®ç¼–è¾‘å™¨æ¨¡æ€æ¡† -->
    <div class="config-editor" id="configEditor" onclick="closeConfigEditor(event)">
        <div class="config-editor-content" onclick="event.stopPropagation()">
            <div class="config-editor-header">
                <h2>ğŸ“ æˆ¿é—´é…ç½®ç¼–è¾‘å™¨</h2>
                <button class="close-btn" onclick="closeConfigEditor()">Ã—</button>
            </div>
            <div class="config-editor-body">
                <textarea id="configTextarea"
                    placeholder='è¾“å…¥JSONé…ç½®ï¼Œä¾‹å¦‚ï¼š&#10;{&#10;  "title": "æˆ‘çš„é…ç½®",&#10;  "settings": {&#10;    "value": 123&#10;  }&#10;}'></textarea>
            </div>
            <div class="config-editor-footer">
                <div class="config-version">ç‰ˆæœ¬: <span id="configVersion">0</span></div>
                <div class="btn-group">
                    <button onclick="closeConfigEditor()">å–æ¶ˆ</button>
                    <button onclick="publishConfig()" class="send-button">å‘å¸ƒé…ç½®</button>
                </div>
            </div>
        </div>
    </div>

    <!-- äºŒç»´ç æ¨¡æ€æ¡† -->
    <div class="qrcode-modal" id="qrcodeModal" onclick="closeQRCode(event)">
        <div class="qrcode-content" onclick="event.stopPropagation()">
            <h2>ğŸ“± æ‰«ç åŠ å…¥æˆ¿é—´</h2>
            <div class="room-info">æˆ¿é—´å·: <strong id="qrRoomId"></strong></div>
            <img id="qrcodeImage" src="" alt="äºŒç»´ç ">
            <button onclick="closeQRCode()" class="send-button">å…³é—­</button>
        </div>
    </div>

    <script>
        let ws = null;
        let currentRoomId = null;
        let currentPermission = null;
        let isAdmin = false;
        let myClientId = null;
        let currentConfig = null;
        let configVersion = 0;

        // è¿æ¥æœåŠ¡å™¨
        function connect() {
            const url = document.getElementById('serverUrl').value;

            try {
                ws = new WebSocket(url);

                ws.onopen = () => {
                    updateStatus('connected');
                    addSystemMessage('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
                };

                ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    handleMessage(message);
                };

                ws.onerror = (error) => {
                    addSystemMessage('è¿æ¥é”™è¯¯');
                };

                ws.onclose = () => {
                    updateStatus('disconnected');
                    addSystemMessage('å·²æ–­å¼€è¿æ¥');
                };
            } catch (error) {
                addSystemMessage('è¿æ¥å¤±è´¥: ' + error.message);
            }
        }

        // æ–­å¼€è¿æ¥
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        // åŠ å…¥æˆ¿é—´
        function joinRoom() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addSystemMessage('è¯·å…ˆè¿æ¥æœåŠ¡å™¨');
                return;
            }

            const roomId = document.getElementById('roomIdInput').value;
            const permission = document.getElementById('permissionSelect').value;

            ws.send(JSON.stringify({
                type: 'join_room',
                data: {
                    roomId: roomId || undefined,
                    permission: permission,
                    isCreate: !roomId
                }
            }));
        }

        // ç¦»å¼€æˆ¿é—´
        function leaveRoom() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addSystemMessage('è¯·å…ˆè¿æ¥æœåŠ¡å™¨');
                return;
            }

            if (!currentRoomId) {
                addSystemMessage('å½“å‰æœªåœ¨ä»»ä½•æˆ¿é—´');
                return;
            }

            ws.send(JSON.stringify({
                type: 'leave_room',
                data: {}
            }));
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addSystemMessage('è¯·å…ˆè¿æ¥æœåŠ¡å™¨');
                return;
            }

            if (!currentRoomId) {
                addSystemMessage('è¯·å…ˆåŠ å…¥æˆ¿é—´');
                return;
            }

            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content) {
                return;
            }

            // å…ˆæ˜¾ç¤ºè‡ªå·±çš„æ¶ˆæ¯
            addChatMessage(content, true, 'æˆ‘');

            // å‘é€åˆ°æœåŠ¡å™¨
            ws.send(JSON.stringify({
                type: 'send_message',
                data: {
                    content: content,
                    encrypted: false
                }
            }));

            input.value = '';
        }

        // è·å–æˆ¿é—´ä¿¡æ¯
        function getRoomInfo() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addSystemMessage('è¯·å…ˆè¿æ¥æœåŠ¡å™¨');
                return;
            }

            ws.send(JSON.stringify({
                type: 'get_room_info',
                data: {}
            }));
        }

        // å¤„ç†æ¶ˆæ¯
        function handleMessage(message) {
            console.log('Received:', message);

            switch (message.type) {
                case 'join':
                    if (message.data.clientId) {
                        myClientId = message.data.clientId;
                    }

                    if (message.data.success) {
                        currentRoomId = message.data.roomId;
                        currentPermission = message.data.permission;
                        isAdmin = message.data.isAdmin;
                        updateRoomInfo(message.data.memberCount);
                        addSystemMessage(`å·²åŠ å…¥æˆ¿é—´: ${currentRoomId}`);
                        document.getElementById('sendButton').disabled = false;
                    }
                    break;

                case 'leave':
                    if (message.data.success) {
                        addSystemMessage(`å·²ç¦»å¼€æˆ¿é—´: ${message.data.roomId}`);
                        currentRoomId = null;
                        currentPermission = null;
                        isAdmin = false;
                        updateRoomInfo(0);
                        document.getElementById('sendButton').disabled = true;
                    }
                    break;

                case 'message':
                    if (message.data.from && message.data.from !== myClientId) {
                        const sender = message.data.from.substring(0, 8);
                        addChatMessage(message.data.content, false, sender);
                    }
                    break;

                case 'broadcast':
                    handleBroadcast(message.data);
                    break;

                case 'room_info':
                    displayRoomInfo(message.data);
                    break;

                case 'error':
                    addSystemMessage('é”™è¯¯: ' + message.data.error);
                    break;

                case 'config_update':
                    handleConfigUpdate(message.data);
                    break;

                case 'publish_config':
                    if (message.data.success) {
                        addSystemMessage(`é…ç½®å·²å‘å¸ƒï¼Œç‰ˆæœ¬: ${message.data.version}`);
                        closeConfigEditor();
                    }
                    break;
            }
        }

        // å¤„ç†å¹¿æ’­æ¶ˆæ¯
        function handleBroadcast(data) {
            switch (data.event) {
                case 'member_joined':
                    addSystemMessage(`æ–°æˆå‘˜åŠ å…¥ï¼Œå½“å‰äººæ•°: ${data.memberCount}`);
                    updateMemberCount(data.memberCount);
                    break;

                case 'member_left':
                    addSystemMessage(`æˆå‘˜ç¦»å¼€ï¼Œå½“å‰äººæ•°: ${data.memberCount}`);
                    updateMemberCount(data.memberCount);
                    break;

                case 'member_kicked':
                    addSystemMessage(`æˆå‘˜è¢«è¸¢å‡ºæˆ¿é—´`);
                    break;

                case 'permission_updated':
                    addSystemMessage(`æƒé™å·²æ›´æ–°`);
                    break;

                case 'config_published':
                    handleConfigUpdate({ config: data.config, version: data.version });
                    addSystemMessage(`é…ç½®å·²æ›´æ–°ï¼Œç‰ˆæœ¬: ${data.version}`);
                    break;
            }
        }

        // æ˜¾ç¤ºæˆ¿é—´ä¿¡æ¯
        function displayRoomInfo(info) {
            let infoText = `æˆ¿é—´ID: ${info.id}\nåœ¨çº¿äººæ•°: ${info.memberCount}/${info.maxMembers}\n\næˆå‘˜åˆ—è¡¨:\n`;
            info.members.forEach((member, index) => {
                infoText += `${index + 1}. ${member.id.substring(0, 8)}... (${member.permission})\n`;
            });
            addSystemMessage(infoText);
        }

        // æ›´æ–°æˆ¿é—´ä¿¡æ¯
        function updateRoomInfo(memberCount) {
            const roomItem = document.getElementById('currentRoomItem');
            const chatTitle = document.getElementById('chatTitle');
            const chatInfo = document.getElementById('chatInfo');
            const configBtn = document.getElementById('configBtn');
            const qrcodeBtn = document.getElementById('qrcodeBtn');

            if (currentRoomId) {
                roomItem.style.display = 'block';
                document.getElementById('roomName').textContent = currentRoomId;
                document.getElementById('memberCountBadge').textContent = `${memberCount}äºº`;
                document.getElementById('roomPermission').textContent = `æƒé™: ${currentPermission}`;

                let titleText = `æˆ¿é—´: ${currentRoomId}`;
                if (isAdmin) {
                    titleText += ' (ç®¡ç†å‘˜)';
                }
                chatTitle.textContent = titleText;
                chatInfo.textContent = `${memberCount} äººåœ¨çº¿ Â· ${currentPermission}`;

                // æ˜¾ç¤ºç®¡ç†å‘˜æŒ‰é’®
                if (isAdmin) {
                    configBtn.style.display = 'inline-block';
                    qrcodeBtn.style.display = 'inline-block';
                } else {
                    configBtn.style.display = 'none';
                    qrcodeBtn.style.display = 'none';
                }
            } else {
                roomItem.style.display = 'none';
                chatTitle.textContent = 'E2E WebSocket Chat';
                chatInfo.textContent = 'è¯·è¿æ¥æœåŠ¡å™¨å¹¶åŠ å…¥æˆ¿é—´å¼€å§‹èŠå¤©';
                configBtn.style.display = 'none';
                qrcodeBtn.style.display = 'none';
            }
        }

        // æ›´æ–°æˆå‘˜æ•°é‡
        function updateMemberCount(count) {
            document.getElementById('memberCountBadge').textContent = `${count}äºº`;
            document.getElementById('chatInfo').textContent = `${count} äººåœ¨çº¿ Â· ${currentPermission}`;
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateStatus(status) {
            const statusDot = document.getElementById('statusDot');
            if (status === 'connected') {
                statusDot.classList.add('connected');
            } else {
                statusDot.classList.remove('connected');
            }
        }

        // æ·»åŠ èŠå¤©æ¶ˆæ¯ï¼ˆæ°”æ³¡æ ·å¼ï¼‰
        function addChatMessage(content, isMine, sender) {
            const container = document.getElementById('messagesContainer');

            const wrapper = document.createElement('div');
            wrapper.className = 'message-wrapper' + (isMine ? ' mine' : '');

            // å¤´åƒ
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender ? sender.substring(0, 2).toUpperCase() : 'æˆ‘';

            // å†…å®¹åŒ…è£…
            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'message-content-wrapper';

            // ä¿¡æ¯ï¼ˆå‘é€è€…å’Œæ—¶é—´ï¼‰
            const info = document.createElement('div');
            info.className = 'message-info';
            const time = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            info.textContent = isMine ? time : `${sender} ${time}`;

            // æ°”æ³¡
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble ' + (isMine ? 'mine' : 'other');
            bubble.textContent = content;

            contentWrapper.appendChild(info);
            contentWrapper.appendChild(bubble);

            wrapper.appendChild(avatar);
            wrapper.appendChild(contentWrapper);

            container.appendChild(wrapper);
            container.scrollTop = container.scrollHeight;
        }

        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function addSystemMessage(text) {
            const container = document.getElementById('messagesContainer');
            const message = document.createElement('div');
            message.className = 'system-message';
            message.innerHTML = `<span>${text}</span>`;
            container.appendChild(message);
            container.scrollTop = container.scrollHeight;
        }

        // é”®ç›˜äº‹ä»¶å¤„ç†
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // é…ç½®ç®¡ç†åŠŸèƒ½
        function handleConfigUpdate(data) {
            currentConfig = data.config;
            configVersion = data.version;

            if (currentConfig) {
                addSystemMessage(`æ”¶åˆ°é…ç½®æ›´æ–°ï¼Œç‰ˆæœ¬: ${configVersion}`);

                // å¦‚æœé…ç½®ç¼–è¾‘å™¨æ‰“å¼€ï¼Œæ›´æ–°å†…å®¹
                const textarea = document.getElementById('configTextarea');
                if (textarea && document.getElementById('configEditor').classList.contains('show')) {
                    textarea.value = JSON.stringify(currentConfig, null, 2);
                    document.getElementById('configVersion').textContent = configVersion;
                }
            }
        }

        function openConfigEditor() {
            if (!isAdmin) {
                addSystemMessage('åªæœ‰ç®¡ç†å‘˜å¯ä»¥ç¼–è¾‘é…ç½®');
                return;
            }

            const editor = document.getElementById('configEditor');
            const textarea = document.getElementById('configTextarea');

            // åŠ è½½å½“å‰é…ç½®
            if (currentConfig) {
                textarea.value = JSON.stringify(currentConfig, null, 2);
            } else {
                textarea.value = '{\n  "title": "ç¤ºä¾‹é…ç½®",\n  "settings": {}\n}';
            }

            document.getElementById('configVersion').textContent = configVersion;
            editor.classList.add('show');
        }

        function closeConfigEditor(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('configEditor').classList.remove('show');
        }

        function publishConfig() {
            const textarea = document.getElementById('configTextarea');
            const configText = textarea.value.trim();

            if (!configText) {
                addSystemMessage('é…ç½®å†…å®¹ä¸èƒ½ä¸ºç©º');
                return;
            }

            try {
                // éªŒè¯JSONæ ¼å¼
                const configData = JSON.parse(configText);

                // å‘é€é…ç½®
                ws.send(JSON.stringify({
                    type: 'publish_config',
                    data: {
                        config: configData
                    }
                }));

                addSystemMessage('æ­£åœ¨å‘å¸ƒé…ç½®...');
            } catch (error) {
                addSystemMessage('JSONæ ¼å¼é”™è¯¯: ' + error.message);
            }
        }

        // è·å–API URLï¼ˆè‡ªåŠ¨æ£€æµ‹ç¯å¢ƒï¼‰
        function getApiUrl() {
            // å¦‚æœæ˜¯ä»æœåŠ¡å™¨åŠ è½½çš„ï¼ˆé€šè¿‡HTTPï¼‰ï¼Œä½¿ç”¨å½“å‰åŸŸåå’Œç«¯å£
            if (window.location.protocol.startsWith('http')) {
                return `${window.location.protocol}//${window.location.host}`;
            }
            // å¦‚æœæ˜¯æœ¬åœ°æ–‡ä»¶ï¼ˆfile://ï¼‰ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
            return 'http://localhost:3001';
        }

        // äºŒç»´ç åŠŸèƒ½
        function showQRCode() {
            if (!currentRoomId) {
                addSystemMessage('è¯·å…ˆåŠ å…¥æˆ¿é—´');
                return;
            }

            const modal = document.getElementById('qrcodeModal');
            const img = document.getElementById('qrcodeImage');
            const roomIdEl = document.getElementById('qrRoomId');

            // è·å–å½“å‰URLçš„åè®®å’Œä¸»æœº
            const apiUrl = getApiUrl();
            const qrcodeUrl = `${apiUrl}/api/rooms/${currentRoomId}/qrcode?format=data`;

            roomIdEl.textContent = currentRoomId;

            // è·å–äºŒç»´ç 
            fetch(qrcodeUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        img.src = data.data.dataUrl;
                        modal.classList.add('show');
                    } else {
                        addSystemMessage('ç”ŸæˆäºŒç»´ç å¤±è´¥');
                    }
                })
                .catch(error => {
                    addSystemMessage('è·å–äºŒç»´ç å¤±è´¥: ' + error.message);
                });
        }

        function closeQRCode(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('qrcodeModal').classList.remove('show');
        }

        // ä»URLå‚æ•°è‡ªåŠ¨åŠ å…¥æˆ¿é—´
        function checkAutoJoin() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('roomId');

            if (roomId) {
                addSystemMessage(`æ£€æµ‹åˆ°æˆ¿é—´å·: ${roomId}ï¼Œå‡†å¤‡è‡ªåŠ¨åŠ å…¥...`);
                document.getElementById('roomIdInput').value = roomId;

                // ç­‰å¾…è¿æ¥åè‡ªåŠ¨åŠ å…¥
                setTimeout(() => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        joinRoom();
                    }
                }, 1000);
            }
        }

        // è·å–WebSocket URLï¼ˆè‡ªåŠ¨æ£€æµ‹ç¯å¢ƒï¼‰
        function getWebSocketUrl() {
            // å¦‚æœæ˜¯ä»æœåŠ¡å™¨åŠ è½½çš„ï¼ˆé€šè¿‡HTTPï¼‰ï¼Œä½¿ç”¨å½“å‰åŸŸå
            if (window.location.protocol.startsWith('http')) {
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.hostname;
                const port = 8080; // WebSocket ç«¯å£
                return `${wsProtocol}//${host}:${port}`;
            }
            // å¦‚æœæ˜¯æœ¬åœ°æ–‡ä»¶ï¼ˆfile://ï¼‰ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
            return 'ws://localhost:8080';
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.onload = () => {
            // è‡ªåŠ¨å¡«å……WebSocketåœ°å€
            document.getElementById('serverUrl').value = getWebSocketUrl();

            addSystemMessage('æ¬¢è¿ä½¿ç”¨ E2E WebSocket Chat');
            checkAutoJoin();
        };
    </script>
</body>

</html>
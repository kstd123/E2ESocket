# 配置管理和二维码功能 - 快速指南

## 🚀 快速开始

### 1. 安装依赖

首先安装新的依赖包：

```bash
npm install
```

这会安装 `qrcode` 库用于生成二维码。

### 2. 启动服务器

```bash
npm start
```

### 3. 打开客户端

在浏览器中打开 `examples/client.html`

## 📝 使用配置功能

### 作为管理员（创建房间者）

#### 步骤 1: 创建房间

1. 连接服务器
2. 留空房间号
3. 选择"可读可写"
4. 点击"加入房间"

你会自动成为管理员，标题栏显示 **"房间: ABC123 (管理员)"**

#### 步骤 2: 打开配置编辑器

点击顶部的 **"⚙️ 配置"** 按钮

#### 步骤 3: 编辑配置

在编辑器中输入JSON配置，例如：

```json
{
  "gameMode": "competitive",
  "maxPlayers": 10,
  "settings": {
    "difficulty": "hard",
    "friendly_fire": false
  }
}
```

#### 步骤 4: 发布配置

点击 **"发布配置"** 按钮

- ✅ 配置会被验证
- ✅ 版本号自动递增
- ✅ 自动广播给所有成员
- ✅ 系统显示：`配置已发布，版本: 1`

#### 步骤 5: 查看二维码

点击顶部的 **"📱 二维码"** 按钮

- 显示房间二维码
- 其他人可以扫码加入

### 作为普通成员

#### 加入方式 1: 手动输入房间号

1. 连接服务器
2. 输入房间号（如 ABC123）
3. 选择权限
4. 点击"加入房间"

#### 加入方式 2: 扫描二维码

1. 用手机扫描管理员显示的二维码
2. 打开链接（如 `http://xxx/join?roomId=ABC123`）
3. 自动连接并加入房间

#### 接收配置

加入房间后，你会自动收到最新配置：

```
系统消息: 收到配置更新，版本: 1
```

#### 查看配置

虽然不能编辑，但可以在控制台查看配置：

```javascript
// 按F12打开控制台
console.log(currentConfig);
```

## 💡 使用场景示例

### 场景 1: 游戏房间

**管理员发布配置**:
```json
{
  "gameType": "capture_the_flag",
  "map": "desert",
  "maxScore": 50,
  "timeLimit": 600,
  "rules": {
    "friendly_fire": false,
    "respawn": true,
    "respawn_time": 5
  }
}
```

**玩家收到配置后**:
- 游戏自动切换到"夺旗模式"
- 加载沙漠地图
- 设置50分为胜利条件
- 10分钟时间限制

### 场景 2: 协作文档

**管理员发布配置**:
```json
{
  "document": {
    "title": "项目需求文档",
    "version": "1.0",
    "template": "standard"
  },
  "permissions": {
    "edit": true,
    "comment": true,
    "download": true
  },
  "settings": {
    "auto_save": true,
    "track_changes": true
  }
}
```

**成员收到配置后**:
- 加载文档模板
- 应用权限设置
- 启用自动保存和修订追踪

### 场景 3: 活动组织

**管理员发布配置**:
```json
{
  "event": {
    "name": "技术交流会",
    "date": "2025-12-01",
    "location": "会议室A"
  },
  "agenda": [
    "09:00 - 签到",
    "09:30 - 主题演讲",
    "11:00 - 讨论环节",
    "12:00 - 午餐"
  ],
  "materials": [
    "演示文稿",
    "代码示例",
    "参考文档"
  ]
}
```

**参与者收到配置后**:
- 查看活动详情
- 了解议程安排
- 准备相关材料

## 🔄 更新配置

### 当需要修改配置时

1. 管理员打开配置编辑器
2. 编辑JSON（旧配置会自动加载）
3. 点击"发布配置"

**效果**:
- 旧配置被替换
- 版本号递增（如 1 → 2）
- 所有成员收到新配置
- 系统显示：`配置已更新，版本: 2`

### 配置更新流程图

```
管理员编辑配置
      ↓
  点击发布
      ↓
  验证JSON格式
      ↓
  发送到服务器
      ↓
服务器验证权限
      ↓
更新房间配置
      ↓
版本号 +1
      ↓
广播给所有成员
      ↓
成员收到新配置
      ↓
  应用新配置
```

## 📱 二维码功能

### 生成二维码

管理员点击 **"📱 二维码"** 按钮：

1. 系统调用API生成二维码
2. 二维码包含房间号和加入链接
3. 显示在模态框中

### 二维码内容

扫描二维码后解析的JSON：

```json
{
  "type": "e2e-chat-room",
  "roomId": "ABC123",
  "joinUrl": "http://localhost:3000/join?roomId=ABC123",
  "timestamp": 1234567890
}
```

### 使用二维码

**方式 1: 直接打开链接**
- 扫码后打开浏览器
- 自动跳转到加入页面
- 房间号已预填
- 点击"连接"和"加入房间"

**方式 2: 获取API二维码**
```bash
# PNG格式
curl http://localhost:3000/api/rooms/ABC123/qrcode > qrcode.png

# SVG格式
curl http://localhost:3000/api/rooms/ABC123/qrcode?format=svg > qrcode.svg

# Data URL
curl http://localhost:3000/api/rooms/ABC123/qrcode?format=data
```

## 🎯 最佳实践

### 配置设计

✅ **推荐**:
```json
{
  "version": "1.0",
  "title": "配置名称",
  "description": "配置说明",
  "settings": {
    "key1": "value1",
    "key2": 123
  }
}
```

❌ **不推荐**:
```json
{
  "x": 1,
  "y": true,
  "z": "abc"
}
```

### 配置版本控制

在配置中包含版本信息：

```json
{
  "configVersion": "1.0.0",
  "lastUpdated": "2025-11-17",
  "changes": "初始版本",
  "settings": {}
}
```

### 配置验证

发布前验证配置：

```javascript
// 检查必填字段
const requiredFields = ['title', 'settings'];
for (const field of requiredFields) {
    if (!config[field]) {
        throw new Error(`缺少必填字段: ${field}`);
    }
}
```

## 🐛 常见问题

### Q: 配置按钮不显示？

**A**: 只有管理员（创建房间的人）才能看到配置按钮。确保你是第一个加入房间的。

### Q: JSON格式错误？

**A**: 检查JSON语法：
- 所有字符串用双引号
- 最后一个属性后面不要逗号
- 使用在线JSON验证工具检查

### Q: 配置没有广播？

**A**: 检查：
1. 是否是管理员
2. WebSocket连接是否正常
3. 查看浏览器控制台错误

### Q: 二维码无法生成？

**A**: 确保：
1. API服务器运行正常（端口3000）
2. 已加入房间
3. 网络连接正常

### Q: 扫码后无法加入？

**A**: 检查：
1. URL格式正确
2. 服务器可访问
3. 房间仍然存在

## 📚 相关文档

- **完整文档**: [配置管理和二维码功能.md](配置管理和二维码功能.md)
- **API文档**: README.md
- **快速开始**: QUICKSTART.md

## 💬 获取帮助

如有问题：
1. 查看浏览器控制台（F12）
2. 查看服务器日志
3. 阅读完整文档
4. 提交Issue

---

**快速上手，轻松管理！** 🚀

